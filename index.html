<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mood Based Music</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <h1>ðŸŽµ Mood-Based Music Player</h1>

  <!-- Upload Image -->
  <input type="file" id="fileInput">
  <button onclick="analyzeMood()">Analyze Mood</button>

  <h2>Or Use Camera ðŸ“·</h2>
  <video id="camera" autoplay></video>
  <button onclick="captureAndAnalyze()">Capture & Analyze</button>

  <h3 id="result">Detected Mood: --</h3>
  <div id="playlist"></div>

  <script>
    const playlists = {
      happy: "https://open.spotify.com/playlist/3kSi9gg8PI45fy4y0XyhJb",
      sad: "https://open.spotify.com/playlist/1IOMaXoRVeIEXZpX3xAqcy",
      angry: "https://open.spotify.com/playlist/37i9dQZF1DWUvHZA1zLcjW",
      neutral: "https://open.spotify.com/playlist/55PVuXcePN1SJUh8yczGuR",
      surprised: "https://open.spotify.com/playlist/37i9dQZF1DXdxcBWuJkbcy",
      fear: "https://open.spotify.com/playlist/37i9dQZF1DX2sUQwD7tbmL",
      disgust: "https://open.spotify.com/playlist/37i9dQZF1DXaXB8fQg7xif"
    };

    async function analyzeMood() {
      const fileInput = document.getElementById("fileInput");
      if (!fileInput.files.length) {
        alert("Please upload an image first!");
        return;
      }
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      await sendRequest(formData);
    }

    const camera = document.getElementById("camera");
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { camera.srcObject = stream; });

    async function captureAndAnalyze() {
      const canvas = document.createElement("canvas");
      canvas.width = camera.videoWidth;
      canvas.height = camera.videoHeight;
      canvas.getContext("2d").drawImage(camera, 0, 0);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg"));
      const formData = new FormData();
      formData.append("file", blob, "capture.jpg");

      await sendRequest(formData);
    }

    async function sendRequest(formData) {
      const response = await fetch("/analyze", { method: "POST", body: formData });
      const data = await response.json();

      if (data.error) {
        document.getElementById("result").innerText = "Error: " + data.error;
      } else {
        const emotion = data.emotion.toLowerCase();
        document.getElementById("result").innerText = `Detected Mood: ${emotion}`;

        if (playlists[emotion]) {
          const embedUrl = playlists[emotion].replace("open.spotify.com/playlist/", "open.spotify.com/embed/playlist/");
          document.getElementById("playlist").innerHTML =
            `<iframe src="${embedUrl}" width="100%" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`;
        } else {
          document.getElementById("playlist").innerText = "No playlist available for this mood.";
        }
      }
    }
  </script>
</body>
</html>
